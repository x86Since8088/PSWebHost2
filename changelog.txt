# Changelog

## 2025-09-27

### Refactoring of Database and Authentication Modules

This change involved a significant refactoring of the `PSWebHost_Database` and `PSWebHost_Authentication` modules to improve separation of concerns.

#### `PSWebHost_Database` Module (`modules/PSWebHost_Database/`)

- This module has been simplified to contain only four generic, low-level functions for interacting with the SQLite database:
    - `Get-PSWebSQLiteData`
    - `Invoke-PSWebSQLiteNonQuery`
    - `New-PSWebSQLiteData`
    - `Sanitize-SqlQueryString`

#### `PSWebHost_Authentication` Module (`modules/PSWebHost_Authentication/`)

- This module now contains the application-specific logic for user, role, and group management that was previously located or incorrectly listed in the `PSWebHost_Database` module.
- **Moved Functions:** The majority of the application-level database functions were moved here. This includes:
    - `Get-PSWebUser`, `Get-PSWebHostUsers`
    - `New-PSWebHostRole`, `Remove-PSWebHostRole`
    - `Add-PSWebHostUserToRole`, `Remove-PSWebHostUserFromRole`
    - `New-PSWebHostGroup`, `Remove-PSWebHostGroup`
    - `Add-PSWebHostUserToGroup`, `Remove-PSWebHostUserFromGroup`
    - `Register-PSWebHostUser`, `New-PSWebHostUser`
- **Refactored/Renamed Functions:** Some functionality was consolidated into new or existing functions within this module:
    - Logic for `Get-LastLoginAttempt` and `Set-LastLoginAttempt` is now part of `Test-LoginLockout` and `PSWebLogon`.
    - Logic for `Set-LoginSession` is now part of `PSWebLogon`.

#### Deleted Functions

- Some functions that were previously listed in the `PSWebHost_Database.psd1` manifest could not be found in the project and are presumed to have been deleted during refactoring. Examples include:
    - `Initialize-PSWebHostDatabase`
    - `Get-CardSettings`
    - `ConvertFrom-CompressedBase64`

### Module Review

- [complete] Scan and correct issues in `PSWebHost_Formatters` module.
    - [complete] Add max depth check to `Convert-ObjectToYaml` to prevent infinite recursion.
    - [complete] Add comment to broken `Safe-WalkObject` function noting it is incomplete.
    - [complete] Replace all `Mandatory=$true` parameters in `PSWebHost_Formatters` module with manual checks.
- [complete] Scan and correct issues in `PSWebHost_Support` module.
    - [complete] Fix critical bug in `Process-HttpRequest` hashtable assignment.
    - [complete] Remove duplicate `Sanitize-SqlQueryString` function.
    - [complete] Add `try/catch` blocks to `Get-RequestBody` and `ConvertTo-CompressedBase64`.
    - [complete] Replace `Write-Host` with `Write-Verbose` in `Process-HttpRequest` and `Validate-UserSession`.
    - [complete] Replace all `Mandatory=$true` parameters in `PSWebHost_Support` module with manual checks.
    - [complete] Remove `Sanitize-SqlQueryString` from `PSWebHost_Support.psd1` manifest.
- [complete] Scan and correct issues in `Sanitization` module.
    - [complete] Fix bug in `Sanitize-FilePath` by removing undefined variables from log messages.
    - [complete] Change `Write-Host` to `Write-Warning` in `Write-RequestSanitizationFail`.
    - [complete] Replace `Mandatory=$true` parameter in `Sanitize-FilePath` with a manual check.
- [complete] Scan and correct issues in `smtp` module.
    - [complete] Replace all `Mandatory=$true` parameters in `smtp` module with manual checks.

### Core Script Review
- [complete] Scan and correct issues in `WebHost.ps1` and its direct dependencies.
    - [complete] Add `try/catch` block to the main listener loop in `WebHost.ps1`.
    - [complete] Replace all `Write-Host` calls in `WebHost.ps1` with `Write-Verbose`.
- [complete] Scan and correct issues in `validateInstall.ps1`.
    - [complete] Replace obsolete database function calls with a call to `validatetables.ps1`.
    - [complete] Change `Write-Host` to `Write-Warning` for database creation message.
- [complete] Scan and correct issues in `pswebadmin.ps1`.
    - [complete] Refactor user creation to use `New-PSWebHostUser`.
    - [complete] Create a new `Set-PSWebHostUserPassword` function and use it for password resets.
    - [complete] Comment out broken role and group management sections.
    - [complete] Replace all `Write-Host` calls with `Write-Verbose` or `Write-Output`.
    - [complete] Fix bug in `Invoke-AuthenticationMethod` to correctly read password from `data` column.
- [complete] Scan and correct issues in `Validate3rdPartyModules.ps1`.
    - [complete] Fix typo in `$HighestViquiredVersion` variable name.
    - [complete] Replace all `Write-Host` calls with `Write-Verbose` or `Write-Warning`.

### Final Script Review
- [complete] Scan and correct issues in remaining `system` scripts.
    - [complete] Refactor `Functions.ps1` to remove unused functions and add error handling.
    - [complete] Review and fix issues in `system/auth` scripts.

### Route Handler Review
- [complete] Scan and correct issues in all `routes/**/*.ps1` scripts.
    - [complete] Stabilize `routes/api/v1/auth` scripts (delete corrupted file, fix bugs, comment out broken flow).
    - [complete] Stabilize `routes/api/v1/authprovider` scripts (disable MFA flow, fix minor bugs).
    - [complete] Review and fix issues in `routes/api/v1/users` and `routes/api/v1/registration` scripts.
        - [complete] Fix SQL injection vulnerabilities in `users/delete.ps1`, `registration/post.ps1`, and `registration/confirm/email/get.ps1`.
        - [complete] Fix broken dependency in `users/post.ps1`.
        - [complete] Fix minor logging and error handling issues.
    - [complete] Review and fix issues in `routes/api/v1/config` scripts (no issues found).
    - [complete] Review and fix issues in `routes/api/v1/db` scripts.
        - [complete] Neutralize critical SQL injection vulnerability in `query/post.ps1` by disabling the endpoint.
    - [complete] Review and fix issues in `routes/api/v1/debug`, `session`, and `status` scripts.
        - [complete] Fix broken function call in `session/get.ps1`.
        - [complete] Fix logging and error handling in `debug` scripts.
## 2025-09-29
- [complete] Fix multiple runtime errors.
    - [complete] Allowed null values for datetime parameters in `Set-LastLoginAttempt` to prevent conversion errors on successful login.
    - [complete] Refactored `Set-LastLoginAttempt` to construct its own SQL query, fixing a call to the generic `Invoke-PSWebSQLiteNonQuery` which no longer accepts a `-TableName` parameter.
    - [complete] Corrected JSON serialization in the `/api/v1/debug/vars` route to handle complex dictionary types.
- [complete] Fix Windows authentication error and improve server stability.
    - [complete] Added `Add-Type` for `System.DirectoryServices.AccountManagement` to `Test-PSWebWindowsAuth.ps1` to prevent type not found errors.
    - [complete] Added a `try/catch` block around the synchronous request handler in `WebHost.ps1` to prevent single request failures from crashing the server.
- [complete] Add verbose logging to HttpListener startup.
    - [complete] Added detailed `Write-Verbose` statements to `WebHost.ps1` to trace the listener initialization and start process.
- [complete] Fix database query error for login attempts.
    - [complete] Corrected table name from `LoginAttempts` to `LastLoginAttempt` in `Get-LastLoginAttempt` and `Set-LastLoginAttempt` functions to match database schema.
- [complete] Fix syntax error in `PSWebHost_Authentication.psm1` that prevented module from loading.
    - [complete] Corrected an unterminated string in the `Test-IsValidEmailAddress` function's parameter block.
- [complete] Continue route handler review.
    - [complete] Reviewed `routes/api/v1/ui`, `spa`, and `api/ManageWindows` script directories; no `.ps1` files were found to analyze.
- [complete] Investigate and fix module and database inconsistencies.
    - [complete] Re-implemented missing session and card-setting functions (`Get-LoginSession`, `Set-LoginSession`, `Get-CardSettings`, etc.) in the `PSWebHost_Authentication` module.
    - [complete] Updated the `PSWebHost_Authentication.psd1` manifest to export the new functions.
    - [complete] Refactored `PSWebHost_Support.psm1` to use the new functions and remove incorrect imports and direct database calls.
    - [complete] Removed incorrect `Import-Module` statements from route handlers.
    - [complete] Synchronized `system/db/sqlite/sqliteconfig.json` with the live database schema, adding missing tables and correcting definitions.
    - [complete] Repaired and ran the `system/db/sqlite/validatetables.ps1` script to confirm database consistency.
- [complete] Standardize authentication function names to `[Verb]-PSWebHost[Object]` format and fix related errors.
    - [complete] Renamed role, group, and user management functions in `PSWebHost_Authentication` module.
    - [complete] Updated `PSWebHost_Authentication.psd1` to export new function names.
    - [complete] Updated `init.ps1`, `pswebadmin.ps1`, and `PSWebHost_Support.psm1` to use the new standardized functions, fixing bugs in the process.